{"version":3,"file":"index.umd.js","sources":["../src/helpers.ts","../src/configuration.ts","../src/controller.ts","../src/logParser.ts","../src/resolver.ts"],"sourcesContent":["import { getAddress } from '@ethersproject/address'\nimport { BigNumber } from '@ethersproject/bignumber'\nimport { computeAddress } from '@ethersproject/transactions'\nimport { VerificationMethod } from 'did-resolver'\n\nexport const identifierMatcher = /^(.*)?(0x[0-9a-fA-F]{40}|0x[0-9a-fA-F]{66})$/\nexport const nullAddress = '0x0000000000000000000000000000000000000000'\nexport const DEFAULT_REGISTRY_ADDRESS = '0xdca7ef03e98e0dc2b855be647c39abe984fcf21b'\nexport const DEFAULT_JSON_RPC = 'http://127.0.0.1:8545/'\n\nexport type address = string\nexport type uint256 = BigNumber\nexport type bytes32 = string\nexport type bytes = string\n\nexport interface ERC1056Event {\n  identity: address\n  previousChange: uint256\n  validTo?: uint256\n  _eventName: string\n  blockNumber: number\n}\n\nexport interface DIDOwnerChanged extends ERC1056Event {\n  owner: address\n}\n\nexport interface DIDAttributeChanged extends ERC1056Event {\n  name: bytes32\n  value: bytes\n  validTo: uint256\n}\n\nexport interface DIDDelegateChanged extends ERC1056Event {\n  delegateType: bytes32\n  delegate: address\n  validTo: uint256\n}\n\nexport enum verificationMethodTypes {\n  EcdsaSecp256k1VerificationKey2019 = 'EcdsaSecp256k1VerificationKey2019',\n  EcdsaSecp256k1RecoveryMethod2020 = 'EcdsaSecp256k1RecoveryMethod2020',\n  Ed25519VerificationKey2018 = 'Ed25519VerificationKey2018',\n  RSAVerificationKey2018 = 'RSAVerificationKey2018',\n  X25519KeyAgreementKey2019 = 'X25519KeyAgreementKey2019',\n}\n\nexport enum eventNames {\n  DIDOwnerChanged = 'DIDOwnerChanged',\n  DIDAttributeChanged = 'DIDAttributeChanged',\n  DIDDelegateChanged = 'DIDDelegateChanged',\n}\n\nexport interface LegacyVerificationMethod extends VerificationMethod {\n  /**@deprecated */\n  publicKeyHex?: string\n  /**@deprecated */\n  publicKeyBase64?: string\n  /**@deprecated */\n  publicKeyPem?: string\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [x: string]: any\n}\n\nexport const legacyAttrTypes: Record<string, string> = {\n  sigAuth: 'SignatureAuthentication2018',\n  veriKey: 'VerificationKey2018',\n  enc: 'KeyAgreementKey2019',\n}\n\nexport const legacyAlgoMap: Record<string, string> = {\n  /**@deprecated */\n  Secp256k1VerificationKey2018: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n  /**@deprecated */\n  Ed25519SignatureAuthentication2018: verificationMethodTypes.Ed25519VerificationKey2018,\n  /**@deprecated */\n  Secp256k1SignatureAuthentication2018: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n  //keep legacy mapping\n  RSAVerificationKey2018: verificationMethodTypes.RSAVerificationKey2018,\n  Ed25519VerificationKey2018: verificationMethodTypes.Ed25519VerificationKey2018,\n  X25519KeyAgreementKey2019: verificationMethodTypes.X25519KeyAgreementKey2019,\n}\n\nexport function bytes32toString(input: bytes32 | Uint8Array): string {\n  const buff: Buffer = typeof input === 'string' ? Buffer.from(input.slice(2), 'hex') : Buffer.from(input)\n  return buff.toString('utf8').replace(/\\0+$/, '')\n}\n\nexport function stringToBytes32(str: string): string {\n  const buffStr = '0x' + Buffer.from(str).slice(0, 32).toString('hex')\n  return buffStr + '0'.repeat(66 - buffStr.length)\n}\n\nexport function interpretIdentifier(identifier: string): { address: string; publicKey?: string; network?: string } {\n  let id = identifier\n  let network = undefined\n  if (id.startsWith('did:ethr')) {\n    id = id.split('?')[0]\n    const components = id.split(':')\n    id = components[components.length - 1]\n    if (components.length >= 4) {\n      network = components.splice(2, components.length - 3).join(':')\n    }\n  }\n  if (id.length > 42) {\n    return { address: computeAddress(id), publicKey: id, network }\n  } else {\n    return { address: getAddress(id), network } // checksum address\n  }\n}\n\nexport const knownInfuraNetworks: Record<string, string> = {\n  mainnet: '0x1',\n  ropsten: '0x3',\n  rinkeby: '0x4',\n  goerli: '0x5',\n  kovan: '0x2a',\n}\n\nexport const knownNetworks: Record<string, string> = {\n  ...knownInfuraNetworks,\n  rsk: '0x1e',\n  'rsk:testnet': '0x1f',\n  artis_t1: '0x03c401',\n  artis_s1: '0x03c301',\n  matic: '0x89',\n  maticmum: '0x13881',\n}\n\nexport enum Errors {\n  /**\n   * The resolver has failed to construct the DID document.\n   * This can be caused by a network issue, a wrong registry address or malformed logs while parsing the registry history.\n   * Please inspect the `DIDResolutionMetadata.message` to debug further.\n   */\n  notFound = 'notFound',\n\n  /**\n   * The resolver does not know how to resolve the given DID. Most likely it is not a `did:ethr`.\n   */\n  invalidDid = 'invalidDid',\n\n  /**\n   * The resolver is misconfigured or is being asked to resolve a DID anchored on an unknown network\n   */\n  unknownNetwork = 'unknownNetwork',\n}\n","import { BigNumber } from '@ethersproject/bignumber'\nimport { Contract, ContractFactory } from '@ethersproject/contracts'\nimport { InfuraProvider, JsonRpcProvider, Provider } from '@ethersproject/providers'\nimport DidRegistryContract from 'ethr-did-registry'\nimport { DEFAULT_REGISTRY_ADDRESS, knownInfuraNetworks, knownNetworks } from './helpers'\n\n/**\n * A configuration entry for an ethereum network\n * It should contain at least one of `name` or `chainId` AND one of `provider`, `web3`, or `rpcUrl`\n *\n * @example ```js\n * { name: 'development', registry: '0x9af37603e98e0dc2b855be647c39abe984fc2445', rpcUrl: 'http://127.0.0.1:8545/' }\n * { name: 'goerli', chainId: 5, provider: new InfuraProvider('goerli') }\n * { name: 'rinkeby', provider: new AlchemyProvider('rinkeby') }\n * { name: 'rsk:testnet', chainId: '0x1f', rpcUrl: 'https://public-node.testnet.rsk.co' }\n * ```\n */\nexport interface ProviderConfiguration {\n  name?: string\n  provider?: Provider\n  rpcUrl?: string\n  registry?: string\n  chainId?: string | number\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  web3?: any\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [index: string]: any\n}\n\nexport interface MultiProviderConfiguration extends ProviderConfiguration {\n  networks?: ProviderConfiguration[]\n}\n\nexport interface InfuraConfiguration {\n  infuraProjectId: string\n}\n\nexport type ConfigurationOptions = MultiProviderConfiguration | InfuraConfiguration\n\nexport type ConfiguredNetworks = Record<string, Contract>\n\nfunction configureNetworksWithInfura(projectId?: string): ConfiguredNetworks {\n  if (!projectId) {\n    return {}\n  }\n  const networks: ProviderConfiguration[] = [\n    { name: 'mainnet', chainId: '0x1', provider: new InfuraProvider('homestead', projectId) },\n    { name: 'ropsten', chainId: '0x3', provider: new InfuraProvider('ropsten', projectId) },\n    { name: 'rinkeby', chainId: '0x4', provider: new InfuraProvider('rinkeby', projectId) },\n    { name: 'goerli', chainId: '0x5', provider: new InfuraProvider('goerli', projectId) },\n    { name: 'kovan', chainId: '0x2a', provider: new InfuraProvider('kovan', projectId) },\n  ]\n  return configureNetworks({ networks })\n}\n\nexport function getContractForNetwork(conf: ProviderConfiguration): Contract {\n  let provider: Provider = conf.provider || conf.web3?.currentProvider\n  if (!provider) {\n    if (conf.rpcUrl) {\n      const chainIdRaw = conf.chainId ? conf.chainId : knownNetworks[conf.name || '']\n      const chainId = chainIdRaw ? BigNumber.from(chainIdRaw).toNumber() : chainIdRaw\n      const networkName = knownInfuraNetworks[conf.name || ''] ? conf.name?.replace('mainnet', 'homestead') : 'any'\n      provider = new JsonRpcProvider(conf.rpcUrl, chainId || networkName)\n    } else {\n      throw new Error(`invalid_config: No web3 provider could be determined for network ${conf.name || conf.chainId}`)\n    }\n  }\n  const contract: Contract = ContractFactory.fromSolidity(DidRegistryContract)\n    .attach(conf.registry || DEFAULT_REGISTRY_ADDRESS)\n    .connect(provider)\n  return contract\n}\n\nfunction configureNetwork(net: ProviderConfiguration): ConfiguredNetworks {\n  const networks: ConfiguredNetworks = {}\n  const chainId = net.chainId || knownNetworks[net.name || '']\n  if (chainId) {\n    if (net.name) {\n      networks[net.name] = getContractForNetwork(net)\n    }\n    const id = typeof chainId === 'number' ? `0x${chainId.toString(16)}` : chainId\n    networks[id] = getContractForNetwork(net)\n  } else if (net.provider || net.web3 || net.rpcUrl) {\n    networks[net.name || ''] = getContractForNetwork(net)\n  }\n  return networks\n}\n\nfunction configureNetworks(conf: MultiProviderConfiguration): ConfiguredNetworks {\n  return {\n    ...configureNetwork(conf),\n    ...conf.networks?.reduce<ConfiguredNetworks>((networks, net) => {\n      return { ...networks, ...configureNetwork(net) }\n    }, {}),\n  }\n}\n\n/**\n * Generates a configuration that maps ethereum network names and chainIDs to the respective ERC1056 contracts deployed on them.\n * @returns a record of ERC1056 `Contract` instances\n * @param conf configuration options for the resolver. An array of network details.\n * Each network entry should contain at least one of `name` or `chainId` AND one of `provider`, `web3`, or `rpcUrl`\n * For convenience, you can also specify an `infuraProjectId` which will create a mapping for all the networks supported by https://infura.io.\n * @example ```js\n * [\n *   { name: 'development', registry: '0x9af37603e98e0dc2b855be647c39abe984fc2445', rpcUrl: 'http://127.0.0.1:8545/' },\n *   { name: 'goerli', chainId: 5, provider: new InfuraProvider('goerli') },\n *   { name: 'rinkeby', provider: new AlchemyProvider('rinkeby') },\n *   { name: 'rsk:testnet', chainId: '0x1f', rpcUrl: 'https://public-node.testnet.rsk.co' },\n * ]\n * ```\n */\nexport function configureResolverWithNetworks(conf: ConfigurationOptions = {}): ConfiguredNetworks {\n  const networks = {\n    ...configureNetworksWithInfura((<InfuraConfiguration>conf).infuraProjectId),\n    ...configureNetworks(<MultiProviderConfiguration>conf),\n  }\n  if (Object.keys(networks).length === 0) {\n    throw new Error('invalid_config: Please make sure to have at least one network')\n  }\n  return networks\n}\n","import { Signer } from '@ethersproject/abstract-signer'\nimport { CallOverrides, Contract } from '@ethersproject/contracts'\nimport { BlockTag, JsonRpcProvider, Provider, TransactionReceipt } from '@ethersproject/providers'\nimport { getContractForNetwork } from './configuration'\nimport { address, DEFAULT_REGISTRY_ADDRESS, interpretIdentifier, stringToBytes32 } from './helpers'\n\n/**\n * A class that can be used to interact with the ERC1056 contract on behalf of a local controller key-pair\n */\nexport class EthrDidController {\n  private contract: Contract\n  private signer?: Signer\n  private address: string\n  public did: string\n\n  /**\n   * Creates an EthrDidController instance.\n   *\n   * @param identifier - required - a `did:ethr` string or a publicKeyHex or an ethereum address\n   * @param signer - optional - a Signer that represents the current controller key (owner) of the identifier. If a 'signer' is not provided, then a 'contract' with an attached signer can be used.\n   * @param contract - optional - a Contract instance representing a ERC1056 contract. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param chainNameOrId - optional - the network name or chainID, defaults to 'mainnet'\n   * @param provider - optional - a web3 Provider. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param rpcUrl - optional - a JSON-RPC URL that can be used to connect to an ethereum network. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param registry - optional - The ERC1056 registry address. Defaults to '0xdca7ef03e98e0dc2b855be647c39abe984fcf21b'. Only used with 'provider' or 'rpcUrl'\n   */\n  constructor(\n    identifier: string | address,\n    contract?: Contract,\n    signer?: Signer,\n    chainNameOrId = 'mainnet',\n    provider?: Provider,\n    rpcUrl?: string,\n    registry: string = DEFAULT_REGISTRY_ADDRESS\n  ) {\n    // initialize identifier\n    const { address, publicKey, network } = interpretIdentifier(identifier)\n    const net = network || chainNameOrId\n    // initialize contract connection\n    if (contract) {\n      this.contract = contract\n    } else if (provider || signer?.provider || rpcUrl) {\n      const prov = provider || signer?.provider\n      this.contract = getContractForNetwork({ name: net, provider: prov, registry, rpcUrl })\n    } else {\n      throw new Error(' either a contract instance or a provider or rpcUrl is required to initialize')\n    }\n    this.signer = signer\n    this.address = address\n    let networkString = net ? `${net}:` : ''\n    if (networkString in ['mainnet:', '0x1:']) {\n      networkString = ''\n    }\n    this.did = publicKey ? `did:ethr:${networkString}${publicKey}` : `did:ethr:${networkString}${address}`\n  }\n\n  async getOwner(address: address, blockTag?: BlockTag): Promise<string> {\n    const result = await this.contract.functions.identityOwner(address, { blockTag })\n    return result[0]\n  }\n\n  async attachContract(controller?: address | Promise<address>): Promise<Contract> {\n    const currentOwner = controller ? await controller : await this.getOwner(this.address, 'latest')\n    const signer = this.signer\n      ? this.signer\n      : (<JsonRpcProvider>this.contract.provider).getSigner(currentOwner) || this.contract.signer\n    return this.contract.connect(signer)\n  }\n\n  async changeOwner(newOwner: address, options: CallOverrides = {}): Promise<TransactionReceipt> {\n    // console.log(`changing owner for ${oldOwner} on registry at ${registryContract.address}`)\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n\n    const ownerChange = await contract.functions.changeOwner(this.address, newOwner, overrides)\n    return await ownerChange.wait()\n  }\n\n  async addDelegate(\n    delegateType: string,\n    delegateAddress: address,\n    exp: number,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n\n    const delegateTypeBytes = stringToBytes32(delegateType)\n    const addDelegateTx = await contract.functions.addDelegate(\n      this.address,\n      delegateTypeBytes,\n      delegateAddress,\n      exp,\n      overrides\n    )\n    addDelegateTx\n    return await addDelegateTx.wait()\n  }\n\n  async revokeDelegate(\n    delegateType: string,\n    delegateAddress: address,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    delegateType = delegateType.startsWith('0x') ? delegateType : stringToBytes32(delegateType)\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const addDelegateTx = await contract.functions.revokeDelegate(\n      this.address,\n      delegateType,\n      delegateAddress,\n      overrides\n    )\n    return await addDelegateTx.wait()\n  }\n\n  async setAttribute(\n    attrName: string,\n    attrValue: string,\n    exp: number,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      controller: undefined,\n      ...options,\n    }\n    attrName = attrName.startsWith('0x') ? attrName : stringToBytes32(attrName)\n    attrValue = attrValue.startsWith('0x') ? attrValue : '0x' + Buffer.from(attrValue, 'utf-8').toString('hex')\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const setAttrTx = await contract.functions.setAttribute(this.address, attrName, attrValue, exp, overrides)\n    return await setAttrTx.wait()\n  }\n\n  async revokeAttribute(attrName: string, attrValue: string, options: CallOverrides = {}): Promise<TransactionReceipt> {\n    // console.log(`revoking attribute ${attrName}(${attrValue}) for ${identity}`)\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    attrName = attrName.startsWith('0x') ? attrName : stringToBytes32(attrName)\n    attrValue = attrValue.startsWith('0x') ? attrValue : '0x' + Buffer.from(attrValue, 'utf-8').toString('hex')\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const revokeAttributeTX = await contract.functions.revokeAttribute(this.address, attrName, attrValue, overrides)\n    return await revokeAttributeTX.wait()\n  }\n}\n","import { BigNumber } from '@ethersproject/bignumber'\nimport { Contract } from '@ethersproject/contracts'\nimport { Log } from '@ethersproject/providers'\nimport { LogDescription } from '@ethersproject/abi'\nimport { bytes32toString, ERC1056Event } from './helpers'\n\nfunction populateEventMetaClass(logResult: LogDescription, blockNumber: number): ERC1056Event {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const result: Record<string, any> = {}\n  if (logResult.eventFragment.inputs.length !== logResult.args.length) {\n    throw new TypeError('malformed event input. wrong number of arguments')\n  }\n  logResult.eventFragment.inputs.forEach((input, index) => {\n    let val = logResult.args[index]\n    if (typeof val === 'object') {\n      val = BigNumber.from(val)\n    }\n    if (input.type === 'bytes32') {\n      val = bytes32toString(val)\n    }\n    result[input.name] = val\n  })\n  result._eventName = logResult.name\n  result.blockNumber = blockNumber\n  return result as ERC1056Event\n}\n\nexport function logDecoder(contract: Contract, logs: Log[]): ERC1056Event[] {\n  const results: ERC1056Event[] = logs.map((log: Log) => {\n    const res = contract.interface.parseLog(log)\n    const event = populateEventMetaClass(res, log.blockNumber)\n    return event\n  })\n  return results\n}\n","import { Base58 } from '@ethersproject/basex'\nimport { BigNumber } from '@ethersproject/bignumber'\nimport { Block, BlockTag } from '@ethersproject/providers'\nimport { ConfigurationOptions, ConfiguredNetworks, configureResolverWithNetworks } from './configuration'\nimport { EthrDidController } from './controller'\nimport {\n  DIDDocument,\n  DIDResolutionOptions,\n  DIDResolutionResult,\n  DIDResolver,\n  ParsedDID,\n  Resolvable,\n  ServiceEndpoint,\n  VerificationMethod,\n} from 'did-resolver'\nimport {\n  interpretIdentifier,\n  DIDAttributeChanged,\n  DIDDelegateChanged,\n  ERC1056Event,\n  eventNames,\n  legacyAlgoMap,\n  legacyAttrTypes,\n  LegacyVerificationMethod,\n  verificationMethodTypes,\n  identifierMatcher,\n  nullAddress,\n  DIDOwnerChanged,\n  knownNetworks,\n  Errors,\n} from './helpers'\nimport { logDecoder } from './logParser'\nimport * as qs from 'querystring'\n\nexport function getResolver(options: ConfigurationOptions): Record<string, DIDResolver> {\n  return new EthrDidResolver(options).build()\n}\n\nexport class EthrDidResolver {\n  private contracts: ConfiguredNetworks\n\n  constructor(options: ConfigurationOptions) {\n    this.contracts = configureResolverWithNetworks(options)\n  }\n\n  /**\n   * returns the current owner of a DID (represented by an address or public key)\n   *\n   * @param address\n   */\n  async getOwner(address: string, networkId: string, blockTag?: BlockTag): Promise<string> {\n    //TODO: check if address or public key\n    return new EthrDidController(address, this.contracts[networkId]).getOwner(address, blockTag)\n  }\n\n  /**\n   * returns the previous change\n   *\n   * @param address\n   */\n  async previousChange(address: string, networkId: string, blockTag?: BlockTag): Promise<BigNumber> {\n    const result = await this.contracts[networkId].functions.changed(address, { blockTag })\n    // console.log(`last change result: '${BigNumber.from(result['0'])}'`)\n    return BigNumber.from(result['0'])\n  }\n\n  async getBlockMetadata(blockHeight: number, networkId: string): Promise<{ height: string; isoDate: string }> {\n    const block: Block = await this.contracts[networkId].provider.getBlock(blockHeight)\n    return {\n      height: block.number.toString(),\n      isoDate: new Date(block.timestamp * 1000).toISOString().replace('.000', ''),\n    }\n  }\n\n  async changeLog(\n    identity: string,\n    networkId: string,\n    blockTag: BlockTag = 'latest'\n  ): Promise<{ address: string; history: ERC1056Event[]; controllerKey?: string; chainId: number }> {\n    const contract = this.contracts[networkId]\n    const provider = contract.provider\n    const hexChainId = networkId.startsWith('0x') ? networkId : knownNetworks[networkId]\n    //TODO: this can be used to check if the configuration is ok\n    const chainId = hexChainId ? BigNumber.from(hexChainId).toNumber() : (await provider.getNetwork()).chainId\n    const history: ERC1056Event[] = []\n    const { address, publicKey } = interpretIdentifier(identity)\n    const controllerKey = publicKey\n    let previousChange: BigNumber | null = await this.previousChange(address, networkId, blockTag)\n    while (previousChange) {\n      const blockNumber = previousChange\n      // console.log(`gigel ${previousChange}`)\n      const logs = await provider.getLogs({\n        address: contract.address, // networks[networkId].registryAddress,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        topics: [null as any, `0x000000000000000000000000${address.slice(2)}`],\n        fromBlock: previousChange.toHexString(),\n        toBlock: previousChange.toHexString(),\n      })\n      const events: ERC1056Event[] = logDecoder(contract, logs)\n      events.reverse()\n      previousChange = null\n      for (const event of events) {\n        history.unshift(event)\n        if (event.previousChange.lt(blockNumber)) {\n          previousChange = event.previousChange\n        }\n      }\n    }\n    return { address, history, controllerKey, chainId }\n  }\n\n  wrapDidDocument(\n    did: string,\n    address: string,\n    controllerKey: string | undefined,\n    history: ERC1056Event[],\n    chainId: number,\n    blockHeight: string | number,\n    now: BigNumber\n  ): { didDocument: DIDDocument; deactivated: boolean; versionId: number; nextVersionId: number } {\n    const baseDIDDocument: DIDDocument = {\n      '@context': [\n        'https://www.w3.org/ns/did/v1',\n        'https://identity.foundation/EcdsaSecp256k1RecoverySignature2020/lds-ecdsa-secp256k1-recovery2020-0.0.jsonld',\n      ],\n      id: did,\n      verificationMethod: [],\n      authentication: [],\n      assertionMethod: [],\n    }\n\n    let controller = address\n\n    const authentication = [`${did}#controller`]\n\n    let versionId = 0\n    let nextVersionId = Number.POSITIVE_INFINITY\n    let deactivated = false\n    let delegateCount = 0\n    let serviceCount = 0\n    const auth: Record<string, string> = {}\n    const pks: Record<string, VerificationMethod> = {}\n    const services: Record<string, ServiceEndpoint> = {}\n    for (const event of history) {\n      if (blockHeight !== -1 && event.blockNumber > blockHeight) {\n        if (nextVersionId > event.blockNumber) {\n          nextVersionId = event.blockNumber\n        }\n        continue\n      } else {\n        if (versionId < event.blockNumber) {\n          versionId = event.blockNumber\n        }\n      }\n      const validTo = event.validTo || BigNumber.from(0)\n      const eventIndex = `${event._eventName}-${\n        (<DIDDelegateChanged>event).delegateType || (<DIDAttributeChanged>event).name\n      }-${(<DIDDelegateChanged>event).delegate || (<DIDAttributeChanged>event).value}`\n      if (validTo && validTo.gte(now)) {\n        if (event._eventName === eventNames.DIDDelegateChanged) {\n          const currentEvent = <DIDDelegateChanged>event\n          delegateCount++\n          const delegateType = currentEvent.delegateType //conversion from bytes32 is done in logParser\n          switch (delegateType) {\n            case 'sigAuth':\n              auth[eventIndex] = `${did}#delegate-${delegateCount}`\n            // eslint-disable-line no-fallthrough\n            case 'veriKey':\n              pks[eventIndex] = {\n                id: `${did}#delegate-${delegateCount}`,\n                type: verificationMethodTypes.EcdsaSecp256k1RecoveryMethod2020,\n                controller: did,\n                blockchainAccountId: `${currentEvent.delegate}@eip155:${chainId}`,\n              }\n              break\n          }\n        } else if (event._eventName === eventNames.DIDAttributeChanged) {\n          const currentEvent = <DIDAttributeChanged>event\n          const name = currentEvent.name //conversion from bytes32 is done in logParser\n          const match = name.match(/^did\\/(pub|svc)\\/(\\w+)(\\/(\\w+))?(\\/(\\w+))?$/)\n          if (match) {\n            const section = match[1]\n            const algorithm = match[2]\n            const type = legacyAttrTypes[match[4]] || match[4]\n            const encoding = match[6]\n            switch (section) {\n              case 'pub': {\n                delegateCount++\n                const pk: LegacyVerificationMethod = {\n                  id: `${did}#delegate-${delegateCount}`,\n                  type: `${algorithm}${type}`,\n                  controller: did,\n                }\n                pk.type = legacyAlgoMap[pk.type] || algorithm\n                switch (encoding) {\n                  case null:\n                  case undefined:\n                  case 'hex':\n                    pk.publicKeyHex = currentEvent.value.slice(2)\n                    break\n                  case 'base64':\n                    pk.publicKeyBase64 = Buffer.from(currentEvent.value.slice(2), 'hex').toString('base64')\n                    break\n                  case 'base58':\n                    pk.publicKeyBase58 = Base58.encode(Buffer.from(currentEvent.value.slice(2), 'hex'))\n                    break\n                  case 'pem':\n                    pk.publicKeyPem = Buffer.from(currentEvent.value.slice(2), 'hex').toString()\n                    break\n                  default:\n                    pk.value = currentEvent.value\n                }\n                pks[eventIndex] = pk\n                if (match[4] === 'sigAuth') {\n                  auth[eventIndex] = pk.id\n                }\n                break\n              }\n              case 'svc':\n                serviceCount++\n                services[eventIndex] = {\n                  id: `${did}#service-${serviceCount}`,\n                  type: algorithm,\n                  serviceEndpoint: Buffer.from(currentEvent.value.slice(2), 'hex').toString(),\n                }\n                break\n            }\n          }\n        }\n      } else if (event._eventName === eventNames.DIDOwnerChanged) {\n        const currentEvent = <DIDOwnerChanged>event\n        controller = currentEvent.owner\n        if (currentEvent.owner === nullAddress) {\n          deactivated = true\n          break\n        }\n      } else {\n        if (\n          event._eventName === eventNames.DIDDelegateChanged ||\n          (event._eventName === eventNames.DIDAttributeChanged &&\n            (<DIDAttributeChanged>event).name.match(/^did\\/pub\\//))\n        ) {\n          delegateCount++\n        } else if (\n          event._eventName === eventNames.DIDAttributeChanged &&\n          (<DIDAttributeChanged>event).name.match(/^did\\/svc\\//)\n        ) {\n          serviceCount++\n        }\n        delete auth[eventIndex]\n        delete pks[eventIndex]\n        delete services[eventIndex]\n      }\n    }\n\n    const publicKeys: VerificationMethod[] = [\n      {\n        id: `${did}#controller`,\n        type: verificationMethodTypes.EcdsaSecp256k1RecoveryMethod2020,\n        controller: did,\n        blockchainAccountId: `${controller}@eip155:${chainId}`,\n      },\n    ]\n\n    if (controllerKey && controller == address) {\n      publicKeys.push({\n        id: `${did}#controllerKey`,\n        type: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n        controller: did,\n        publicKeyHex: controllerKey,\n      })\n      authentication.push(`${did}#controllerKey`)\n    }\n\n    const didDocument: DIDDocument = {\n      ...baseDIDDocument,\n      verificationMethod: publicKeys.concat(Object.values(pks)),\n      authentication: authentication.concat(Object.values(auth)),\n    }\n    if (Object.values(services).length > 0) {\n      didDocument.service = Object.values(services)\n    }\n    didDocument.assertionMethod = [...(didDocument.verificationMethod?.map((pk) => pk.id) || [])]\n\n    return deactivated\n      ? {\n          didDocument: { ...baseDIDDocument, '@context': 'https://www.w3.org/ns/did/v1' },\n          deactivated,\n          versionId,\n          nextVersionId,\n        }\n      : { didDocument, deactivated, versionId, nextVersionId }\n  }\n\n  async resolve(\n    did: string,\n    parsed: ParsedDID,\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    _unused: Resolvable,\n    options: DIDResolutionOptions\n  ): Promise<DIDResolutionResult> {\n    const fullId = parsed.id.match(identifierMatcher)\n    if (!fullId) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.invalidDid,\n          message: `Not a valid did:ethr: ${parsed.id}`,\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n    const id = fullId[2]\n    const networkId = !fullId[1] ? 'mainnet' : fullId[1].slice(0, -1)\n    let blockTag: string | number = options.blockTag || 'latest'\n    if (typeof parsed.query === 'string') {\n      const qParams = qs.decode(parsed.query)\n      blockTag = typeof qParams['versionId'] === 'string' ? qParams['versionId'] : blockTag\n      try {\n        blockTag = Number.parseInt(<string>blockTag)\n      } catch (e) {\n        blockTag = 'latest'\n        // invalid versionId parameters are ignored\n      }\n    }\n\n    if (!this.contracts[networkId]) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.unknownNetwork,\n          message: `The DID resolver does not have a configuration for network: ${networkId}`,\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n\n    let now = BigNumber.from(Math.floor(new Date().getTime() / 1000))\n\n    if (typeof blockTag === 'number') {\n      const block = await this.getBlockMetadata(blockTag, networkId)\n      now = BigNumber.from(Date.parse(block.isoDate) / 1000)\n    } else {\n      // 'latest'\n    }\n\n    const { address, history, controllerKey, chainId } = await this.changeLog(id, networkId, 'latest')\n    try {\n      const { didDocument, deactivated, versionId, nextVersionId } = this.wrapDidDocument(\n        did,\n        address,\n        controllerKey,\n        history,\n        chainId,\n        blockTag,\n        now\n      )\n      const status = deactivated ? { deactivated: true } : {}\n      let versionMeta = {}\n      let versionMetaNext = {}\n      if (versionId !== 0) {\n        const block = await this.getBlockMetadata(versionId, networkId)\n        versionMeta = {\n          versionId: block.height,\n          updated: block.isoDate,\n        }\n      }\n      if (nextVersionId !== Number.POSITIVE_INFINITY) {\n        const block = await this.getBlockMetadata(nextVersionId, networkId)\n        versionMetaNext = {\n          nextVersionId: block.height,\n          nextUpdate: block.isoDate,\n        }\n      }\n      return {\n        didDocumentMetadata: { ...status, ...versionMeta, ...versionMetaNext },\n        didResolutionMetadata: { contentType: 'application/did+ld+json' },\n        didDocument,\n      }\n    } catch (e) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.notFound,\n          message: e.toString(), // This is not in spec, nut may be helpful\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n  }\n\n  build(): Record<string, DIDResolver> {\n    return { ethr: this.resolve.bind(this) }\n  }\n}\n"],"names":["identifierMatcher","nullAddress","DEFAULT_REGISTRY_ADDRESS","verificationMethodTypes","eventNames","legacyAttrTypes","sigAuth","veriKey","enc","legacyAlgoMap","Secp256k1VerificationKey2018","EcdsaSecp256k1VerificationKey2019","Ed25519SignatureAuthentication2018","Ed25519VerificationKey2018","Secp256k1SignatureAuthentication2018","RSAVerificationKey2018","X25519KeyAgreementKey2019","bytes32toString","input","buff","Buffer","from","slice","toString","replace","stringToBytes32","str","buffStr","repeat","length","interpretIdentifier","identifier","id","network","undefined","startsWith","split","components","splice","join","address","computeAddress","publicKey","getAddress","knownInfuraNetworks","mainnet","ropsten","rinkeby","goerli","kovan","knownNetworks","rsk","artis_t1","artis_s1","matic","maticmum","Errors","configureNetworksWithInfura","projectId","networks","name","chainId","provider","InfuraProvider","configureNetworks","getContractForNetwork","conf","web3","currentProvider","rpcUrl","chainIdRaw","BigNumber","toNumber","networkName","JsonRpcProvider","Error","contract","ContractFactory","fromSolidity","DidRegistryContract","attach","registry","connect","configureNetwork","net","reduce","configureResolverWithNetworks","infuraProjectId","Object","keys","EthrDidController","constructor","signer","chainNameOrId","did","prov","networkString","getOwner","blockTag","functions","identityOwner","result","attachContract","controller","currentOwner","getSigner","changeOwner","newOwner","options","overrides","gasLimit","gasPrice","ownerChange","wait","addDelegate","delegateType","delegateAddress","exp","delegateTypeBytes","addDelegateTx","revokeDelegate","setAttribute","attrName","attrValue","setAttrTx","revokeAttribute","revokeAttributeTX","populateEventMetaClass","logResult","blockNumber","eventFragment","inputs","args","TypeError","forEach","index","val","type","_eventName","logDecoder","logs","results","map","log","res","interface","parseLog","event","state","prototype","s","e","o","_this","thenable","test","updateValue","pact","stage","then","_resumeAfterBody","getResolver","EthrDidResolver","build","contracts","networkId","previousChange","changed","getBlockMetadata","blockHeight","getBlock","block","height","number","isoDate","Date","timestamp","toISOString","changeLog","identity","hexChainId","history","controllerKey","getLogs","topics","fromBlock","toHexString","toBlock","events","reverse","unshift","lt","getNetwork","wrapDidDocument","now","baseDIDDocument","verificationMethod","authentication","assertionMethod","versionId","nextVersionId","Number","POSITIVE_INFINITY","deactivated","delegateCount","serviceCount","auth","pks","services","validTo","eventIndex","delegate","value","gte","DIDDelegateChanged","currentEvent","EcdsaSecp256k1RecoveryMethod2020","blockchainAccountId","DIDAttributeChanged","match","section","algorithm","encoding","pk","publicKeyHex","publicKeyBase64","publicKeyBase58","Base58","encode","publicKeyPem","serviceEndpoint","DIDOwnerChanged","owner","publicKeys","push","didDocument","concat","values","service","resolve","parsed","_unused","didDocumentMetadata","status","versionMeta","versionMetaNext","didResolutionMetadata","contentType","nextUpdate","updated","error","notFound","message","fullId","invalidDid","query","qParams","qs","decode","parseInt","unknownNetwork","Math","floor","getTime","parse","ethr","bind"],"mappings":"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"}