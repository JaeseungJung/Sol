{"version":3,"file":"index.module.js","sources":["../src/helpers.ts","../src/configuration.ts","../src/controller.ts","../src/logParser.ts","../src/resolver.ts"],"sourcesContent":["import { getAddress } from '@ethersproject/address'\nimport { BigNumber } from '@ethersproject/bignumber'\nimport { computeAddress } from '@ethersproject/transactions'\nimport { VerificationMethod } from 'did-resolver'\n\nexport const identifierMatcher = /^(.*)?(0x[0-9a-fA-F]{40}|0x[0-9a-fA-F]{66})$/\nexport const nullAddress = '0x0000000000000000000000000000000000000000'\nexport const DEFAULT_REGISTRY_ADDRESS = '0xdca7ef03e98e0dc2b855be647c39abe984fcf21b'\nexport const DEFAULT_JSON_RPC = 'http://127.0.0.1:8545/'\n\nexport type address = string\nexport type uint256 = BigNumber\nexport type bytes32 = string\nexport type bytes = string\n\nexport interface ERC1056Event {\n  identity: address\n  previousChange: uint256\n  validTo?: uint256\n  _eventName: string\n  blockNumber: number\n}\n\nexport interface DIDOwnerChanged extends ERC1056Event {\n  owner: address\n}\n\nexport interface DIDAttributeChanged extends ERC1056Event {\n  name: bytes32\n  value: bytes\n  validTo: uint256\n}\n\nexport interface DIDDelegateChanged extends ERC1056Event {\n  delegateType: bytes32\n  delegate: address\n  validTo: uint256\n}\n\nexport enum verificationMethodTypes {\n  EcdsaSecp256k1VerificationKey2019 = 'EcdsaSecp256k1VerificationKey2019',\n  EcdsaSecp256k1RecoveryMethod2020 = 'EcdsaSecp256k1RecoveryMethod2020',\n  Ed25519VerificationKey2018 = 'Ed25519VerificationKey2018',\n  RSAVerificationKey2018 = 'RSAVerificationKey2018',\n  X25519KeyAgreementKey2019 = 'X25519KeyAgreementKey2019',\n}\n\nexport enum eventNames {\n  DIDOwnerChanged = 'DIDOwnerChanged',\n  DIDAttributeChanged = 'DIDAttributeChanged',\n  DIDDelegateChanged = 'DIDDelegateChanged',\n}\n\nexport interface LegacyVerificationMethod extends VerificationMethod {\n  /**@deprecated */\n  publicKeyHex?: string\n  /**@deprecated */\n  publicKeyBase64?: string\n  /**@deprecated */\n  publicKeyPem?: string\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [x: string]: any\n}\n\nexport const legacyAttrTypes: Record<string, string> = {\n  sigAuth: 'SignatureAuthentication2018',\n  veriKey: 'VerificationKey2018',\n  enc: 'KeyAgreementKey2019',\n}\n\nexport const legacyAlgoMap: Record<string, string> = {\n  /**@deprecated */\n  Secp256k1VerificationKey2018: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n  /**@deprecated */\n  Ed25519SignatureAuthentication2018: verificationMethodTypes.Ed25519VerificationKey2018,\n  /**@deprecated */\n  Secp256k1SignatureAuthentication2018: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n  //keep legacy mapping\n  RSAVerificationKey2018: verificationMethodTypes.RSAVerificationKey2018,\n  Ed25519VerificationKey2018: verificationMethodTypes.Ed25519VerificationKey2018,\n  X25519KeyAgreementKey2019: verificationMethodTypes.X25519KeyAgreementKey2019,\n}\n\nexport function bytes32toString(input: bytes32 | Uint8Array): string {\n  const buff: Buffer = typeof input === 'string' ? Buffer.from(input.slice(2), 'hex') : Buffer.from(input)\n  return buff.toString('utf8').replace(/\\0+$/, '')\n}\n\nexport function stringToBytes32(str: string): string {\n  const buffStr = '0x' + Buffer.from(str).slice(0, 32).toString('hex')\n  return buffStr + '0'.repeat(66 - buffStr.length)\n}\n\nexport function interpretIdentifier(identifier: string): { address: string; publicKey?: string; network?: string } {\n  let id = identifier\n  let network = undefined\n  if (id.startsWith('did:ethr')) {\n    id = id.split('?')[0]\n    const components = id.split(':')\n    id = components[components.length - 1]\n    if (components.length >= 4) {\n      network = components.splice(2, components.length - 3).join(':')\n    }\n  }\n  if (id.length > 42) {\n    return { address: computeAddress(id), publicKey: id, network }\n  } else {\n    return { address: getAddress(id), network } // checksum address\n  }\n}\n\nexport const knownInfuraNetworks: Record<string, string> = {\n  mainnet: '0x1',\n  ropsten: '0x3',\n  rinkeby: '0x4',\n  goerli: '0x5',\n  kovan: '0x2a',\n}\n\nexport const knownNetworks: Record<string, string> = {\n  ...knownInfuraNetworks,\n  rsk: '0x1e',\n  'rsk:testnet': '0x1f',\n  artis_t1: '0x03c401',\n  artis_s1: '0x03c301',\n  matic: '0x89',\n  maticmum: '0x13881',\n}\n\nexport enum Errors {\n  /**\n   * The resolver has failed to construct the DID document.\n   * This can be caused by a network issue, a wrong registry address or malformed logs while parsing the registry history.\n   * Please inspect the `DIDResolutionMetadata.message` to debug further.\n   */\n  notFound = 'notFound',\n\n  /**\n   * The resolver does not know how to resolve the given DID. Most likely it is not a `did:ethr`.\n   */\n  invalidDid = 'invalidDid',\n\n  /**\n   * The resolver is misconfigured or is being asked to resolve a DID anchored on an unknown network\n   */\n  unknownNetwork = 'unknownNetwork',\n}\n","import { BigNumber } from '@ethersproject/bignumber'\nimport { Contract, ContractFactory } from '@ethersproject/contracts'\nimport { InfuraProvider, JsonRpcProvider, Provider } from '@ethersproject/providers'\nimport DidRegistryContract from 'ethr-did-registry'\nimport { DEFAULT_REGISTRY_ADDRESS, knownInfuraNetworks, knownNetworks } from './helpers'\n\n/**\n * A configuration entry for an ethereum network\n * It should contain at least one of `name` or `chainId` AND one of `provider`, `web3`, or `rpcUrl`\n *\n * @example ```js\n * { name: 'development', registry: '0x9af37603e98e0dc2b855be647c39abe984fc2445', rpcUrl: 'http://127.0.0.1:8545/' }\n * { name: 'goerli', chainId: 5, provider: new InfuraProvider('goerli') }\n * { name: 'rinkeby', provider: new AlchemyProvider('rinkeby') }\n * { name: 'rsk:testnet', chainId: '0x1f', rpcUrl: 'https://public-node.testnet.rsk.co' }\n * ```\n */\nexport interface ProviderConfiguration {\n  name?: string\n  provider?: Provider\n  rpcUrl?: string\n  registry?: string\n  chainId?: string | number\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  web3?: any\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [index: string]: any\n}\n\nexport interface MultiProviderConfiguration extends ProviderConfiguration {\n  networks?: ProviderConfiguration[]\n}\n\nexport interface InfuraConfiguration {\n  infuraProjectId: string\n}\n\nexport type ConfigurationOptions = MultiProviderConfiguration | InfuraConfiguration\n\nexport type ConfiguredNetworks = Record<string, Contract>\n\nfunction configureNetworksWithInfura(projectId?: string): ConfiguredNetworks {\n  if (!projectId) {\n    return {}\n  }\n  const networks: ProviderConfiguration[] = [\n    { name: 'mainnet', chainId: '0x1', provider: new InfuraProvider('homestead', projectId) },\n    { name: 'ropsten', chainId: '0x3', provider: new InfuraProvider('ropsten', projectId) },\n    { name: 'rinkeby', chainId: '0x4', provider: new InfuraProvider('rinkeby', projectId) },\n    { name: 'goerli', chainId: '0x5', provider: new InfuraProvider('goerli', projectId) },\n    { name: 'kovan', chainId: '0x2a', provider: new InfuraProvider('kovan', projectId) },\n  ]\n  return configureNetworks({ networks })\n}\n\nexport function getContractForNetwork(conf: ProviderConfiguration): Contract {\n  let provider: Provider = conf.provider || conf.web3?.currentProvider\n  if (!provider) {\n    if (conf.rpcUrl) {\n      const chainIdRaw = conf.chainId ? conf.chainId : knownNetworks[conf.name || '']\n      const chainId = chainIdRaw ? BigNumber.from(chainIdRaw).toNumber() : chainIdRaw\n      const networkName = knownInfuraNetworks[conf.name || ''] ? conf.name?.replace('mainnet', 'homestead') : 'any'\n      provider = new JsonRpcProvider(conf.rpcUrl, chainId || networkName)\n    } else {\n      throw new Error(`invalid_config: No web3 provider could be determined for network ${conf.name || conf.chainId}`)\n    }\n  }\n  const contract: Contract = ContractFactory.fromSolidity(DidRegistryContract)\n    .attach(conf.registry || DEFAULT_REGISTRY_ADDRESS)\n    .connect(provider)\n  return contract\n}\n\nfunction configureNetwork(net: ProviderConfiguration): ConfiguredNetworks {\n  const networks: ConfiguredNetworks = {}\n  const chainId = net.chainId || knownNetworks[net.name || '']\n  if (chainId) {\n    if (net.name) {\n      networks[net.name] = getContractForNetwork(net)\n    }\n    const id = typeof chainId === 'number' ? `0x${chainId.toString(16)}` : chainId\n    networks[id] = getContractForNetwork(net)\n  } else if (net.provider || net.web3 || net.rpcUrl) {\n    networks[net.name || ''] = getContractForNetwork(net)\n  }\n  return networks\n}\n\nfunction configureNetworks(conf: MultiProviderConfiguration): ConfiguredNetworks {\n  return {\n    ...configureNetwork(conf),\n    ...conf.networks?.reduce<ConfiguredNetworks>((networks, net) => {\n      return { ...networks, ...configureNetwork(net) }\n    }, {}),\n  }\n}\n\n/**\n * Generates a configuration that maps ethereum network names and chainIDs to the respective ERC1056 contracts deployed on them.\n * @returns a record of ERC1056 `Contract` instances\n * @param conf configuration options for the resolver. An array of network details.\n * Each network entry should contain at least one of `name` or `chainId` AND one of `provider`, `web3`, or `rpcUrl`\n * For convenience, you can also specify an `infuraProjectId` which will create a mapping for all the networks supported by https://infura.io.\n * @example ```js\n * [\n *   { name: 'development', registry: '0x9af37603e98e0dc2b855be647c39abe984fc2445', rpcUrl: 'http://127.0.0.1:8545/' },\n *   { name: 'goerli', chainId: 5, provider: new InfuraProvider('goerli') },\n *   { name: 'rinkeby', provider: new AlchemyProvider('rinkeby') },\n *   { name: 'rsk:testnet', chainId: '0x1f', rpcUrl: 'https://public-node.testnet.rsk.co' },\n * ]\n * ```\n */\nexport function configureResolverWithNetworks(conf: ConfigurationOptions = {}): ConfiguredNetworks {\n  const networks = {\n    ...configureNetworksWithInfura((<InfuraConfiguration>conf).infuraProjectId),\n    ...configureNetworks(<MultiProviderConfiguration>conf),\n  }\n  if (Object.keys(networks).length === 0) {\n    throw new Error('invalid_config: Please make sure to have at least one network')\n  }\n  return networks\n}\n","import { Signer } from '@ethersproject/abstract-signer'\nimport { CallOverrides, Contract } from '@ethersproject/contracts'\nimport { BlockTag, JsonRpcProvider, Provider, TransactionReceipt } from '@ethersproject/providers'\nimport { getContractForNetwork } from './configuration'\nimport { address, DEFAULT_REGISTRY_ADDRESS, interpretIdentifier, stringToBytes32 } from './helpers'\n\n/**\n * A class that can be used to interact with the ERC1056 contract on behalf of a local controller key-pair\n */\nexport class EthrDidController {\n  private contract: Contract\n  private signer?: Signer\n  private address: string\n  public did: string\n\n  /**\n   * Creates an EthrDidController instance.\n   *\n   * @param identifier - required - a `did:ethr` string or a publicKeyHex or an ethereum address\n   * @param signer - optional - a Signer that represents the current controller key (owner) of the identifier. If a 'signer' is not provided, then a 'contract' with an attached signer can be used.\n   * @param contract - optional - a Contract instance representing a ERC1056 contract. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param chainNameOrId - optional - the network name or chainID, defaults to 'mainnet'\n   * @param provider - optional - a web3 Provider. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param rpcUrl - optional - a JSON-RPC URL that can be used to connect to an ethereum network. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param registry - optional - The ERC1056 registry address. Defaults to '0xdca7ef03e98e0dc2b855be647c39abe984fcf21b'. Only used with 'provider' or 'rpcUrl'\n   */\n  constructor(\n    identifier: string | address,\n    contract?: Contract,\n    signer?: Signer,\n    chainNameOrId = 'mainnet',\n    provider?: Provider,\n    rpcUrl?: string,\n    registry: string = DEFAULT_REGISTRY_ADDRESS\n  ) {\n    // initialize identifier\n    const { address, publicKey, network } = interpretIdentifier(identifier)\n    const net = network || chainNameOrId\n    // initialize contract connection\n    if (contract) {\n      this.contract = contract\n    } else if (provider || signer?.provider || rpcUrl) {\n      const prov = provider || signer?.provider\n      this.contract = getContractForNetwork({ name: net, provider: prov, registry, rpcUrl })\n    } else {\n      throw new Error(' either a contract instance or a provider or rpcUrl is required to initialize')\n    }\n    this.signer = signer\n    this.address = address\n    let networkString = net ? `${net}:` : ''\n    if (networkString in ['mainnet:', '0x1:']) {\n      networkString = ''\n    }\n    this.did = publicKey ? `did:ethr:${networkString}${publicKey}` : `did:ethr:${networkString}${address}`\n  }\n\n  async getOwner(address: address, blockTag?: BlockTag): Promise<string> {\n    const result = await this.contract.functions.identityOwner(address, { blockTag })\n    return result[0]\n  }\n\n  async attachContract(controller?: address | Promise<address>): Promise<Contract> {\n    const currentOwner = controller ? await controller : await this.getOwner(this.address, 'latest')\n    const signer = this.signer\n      ? this.signer\n      : (<JsonRpcProvider>this.contract.provider).getSigner(currentOwner) || this.contract.signer\n    return this.contract.connect(signer)\n  }\n\n  async changeOwner(newOwner: address, options: CallOverrides = {}): Promise<TransactionReceipt> {\n    // console.log(`changing owner for ${oldOwner} on registry at ${registryContract.address}`)\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n\n    const ownerChange = await contract.functions.changeOwner(this.address, newOwner, overrides)\n    return await ownerChange.wait()\n  }\n\n  async addDelegate(\n    delegateType: string,\n    delegateAddress: address,\n    exp: number,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n\n    const delegateTypeBytes = stringToBytes32(delegateType)\n    const addDelegateTx = await contract.functions.addDelegate(\n      this.address,\n      delegateTypeBytes,\n      delegateAddress,\n      exp,\n      overrides\n    )\n    addDelegateTx\n    return await addDelegateTx.wait()\n  }\n\n  async revokeDelegate(\n    delegateType: string,\n    delegateAddress: address,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    delegateType = delegateType.startsWith('0x') ? delegateType : stringToBytes32(delegateType)\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const addDelegateTx = await contract.functions.revokeDelegate(\n      this.address,\n      delegateType,\n      delegateAddress,\n      overrides\n    )\n    return await addDelegateTx.wait()\n  }\n\n  async setAttribute(\n    attrName: string,\n    attrValue: string,\n    exp: number,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      controller: undefined,\n      ...options,\n    }\n    attrName = attrName.startsWith('0x') ? attrName : stringToBytes32(attrName)\n    attrValue = attrValue.startsWith('0x') ? attrValue : '0x' + Buffer.from(attrValue, 'utf-8').toString('hex')\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const setAttrTx = await contract.functions.setAttribute(this.address, attrName, attrValue, exp, overrides)\n    return await setAttrTx.wait()\n  }\n\n  async revokeAttribute(attrName: string, attrValue: string, options: CallOverrides = {}): Promise<TransactionReceipt> {\n    // console.log(`revoking attribute ${attrName}(${attrValue}) for ${identity}`)\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    attrName = attrName.startsWith('0x') ? attrName : stringToBytes32(attrName)\n    attrValue = attrValue.startsWith('0x') ? attrValue : '0x' + Buffer.from(attrValue, 'utf-8').toString('hex')\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const revokeAttributeTX = await contract.functions.revokeAttribute(this.address, attrName, attrValue, overrides)\n    return await revokeAttributeTX.wait()\n  }\n}\n","import { BigNumber } from '@ethersproject/bignumber'\nimport { Contract } from '@ethersproject/contracts'\nimport { Log } from '@ethersproject/providers'\nimport { LogDescription } from '@ethersproject/abi'\nimport { bytes32toString, ERC1056Event } from './helpers'\n\nfunction populateEventMetaClass(logResult: LogDescription, blockNumber: number): ERC1056Event {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const result: Record<string, any> = {}\n  if (logResult.eventFragment.inputs.length !== logResult.args.length) {\n    throw new TypeError('malformed event input. wrong number of arguments')\n  }\n  logResult.eventFragment.inputs.forEach((input, index) => {\n    let val = logResult.args[index]\n    if (typeof val === 'object') {\n      val = BigNumber.from(val)\n    }\n    if (input.type === 'bytes32') {\n      val = bytes32toString(val)\n    }\n    result[input.name] = val\n  })\n  result._eventName = logResult.name\n  result.blockNumber = blockNumber\n  return result as ERC1056Event\n}\n\nexport function logDecoder(contract: Contract, logs: Log[]): ERC1056Event[] {\n  const results: ERC1056Event[] = logs.map((log: Log) => {\n    const res = contract.interface.parseLog(log)\n    const event = populateEventMetaClass(res, log.blockNumber)\n    return event\n  })\n  return results\n}\n","import { Base58 } from '@ethersproject/basex'\nimport { BigNumber } from '@ethersproject/bignumber'\nimport { Block, BlockTag } from '@ethersproject/providers'\nimport { ConfigurationOptions, ConfiguredNetworks, configureResolverWithNetworks } from './configuration'\nimport { EthrDidController } from './controller'\nimport {\n  DIDDocument,\n  DIDResolutionOptions,\n  DIDResolutionResult,\n  DIDResolver,\n  ParsedDID,\n  Resolvable,\n  ServiceEndpoint,\n  VerificationMethod,\n} from 'did-resolver'\nimport {\n  interpretIdentifier,\n  DIDAttributeChanged,\n  DIDDelegateChanged,\n  ERC1056Event,\n  eventNames,\n  legacyAlgoMap,\n  legacyAttrTypes,\n  LegacyVerificationMethod,\n  verificationMethodTypes,\n  identifierMatcher,\n  nullAddress,\n  DIDOwnerChanged,\n  knownNetworks,\n  Errors,\n} from './helpers'\nimport { logDecoder } from './logParser'\nimport * as qs from 'querystring'\n\nexport function getResolver(options: ConfigurationOptions): Record<string, DIDResolver> {\n  return new EthrDidResolver(options).build()\n}\n\nexport class EthrDidResolver {\n  private contracts: ConfiguredNetworks\n\n  constructor(options: ConfigurationOptions) {\n    this.contracts = configureResolverWithNetworks(options)\n  }\n\n  /**\n   * returns the current owner of a DID (represented by an address or public key)\n   *\n   * @param address\n   */\n  async getOwner(address: string, networkId: string, blockTag?: BlockTag): Promise<string> {\n    //TODO: check if address or public key\n    return new EthrDidController(address, this.contracts[networkId]).getOwner(address, blockTag)\n  }\n\n  /**\n   * returns the previous change\n   *\n   * @param address\n   */\n  async previousChange(address: string, networkId: string, blockTag?: BlockTag): Promise<BigNumber> {\n    const result = await this.contracts[networkId].functions.changed(address, { blockTag })\n    // console.log(`last change result: '${BigNumber.from(result['0'])}'`)\n    return BigNumber.from(result['0'])\n  }\n\n  async getBlockMetadata(blockHeight: number, networkId: string): Promise<{ height: string; isoDate: string }> {\n    const block: Block = await this.contracts[networkId].provider.getBlock(blockHeight)\n    return {\n      height: block.number.toString(),\n      isoDate: new Date(block.timestamp * 1000).toISOString().replace('.000', ''),\n    }\n  }\n\n  async changeLog(\n    identity: string,\n    networkId: string,\n    blockTag: BlockTag = 'latest'\n  ): Promise<{ address: string; history: ERC1056Event[]; controllerKey?: string; chainId: number }> {\n    const contract = this.contracts[networkId]\n    const provider = contract.provider\n    const hexChainId = networkId.startsWith('0x') ? networkId : knownNetworks[networkId]\n    //TODO: this can be used to check if the configuration is ok\n    const chainId = hexChainId ? BigNumber.from(hexChainId).toNumber() : (await provider.getNetwork()).chainId\n    const history: ERC1056Event[] = []\n    const { address, publicKey } = interpretIdentifier(identity)\n    const controllerKey = publicKey\n    let previousChange: BigNumber | null = await this.previousChange(address, networkId, blockTag)\n    while (previousChange) {\n      const blockNumber = previousChange\n      // console.log(`gigel ${previousChange}`)\n      const logs = await provider.getLogs({\n        address: contract.address, // networks[networkId].registryAddress,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        topics: [null as any, `0x000000000000000000000000${address.slice(2)}`],\n        fromBlock: previousChange.toHexString(),\n        toBlock: previousChange.toHexString(),\n      })\n      const events: ERC1056Event[] = logDecoder(contract, logs)\n      events.reverse()\n      previousChange = null\n      for (const event of events) {\n        history.unshift(event)\n        if (event.previousChange.lt(blockNumber)) {\n          previousChange = event.previousChange\n        }\n      }\n    }\n    return { address, history, controllerKey, chainId }\n  }\n\n  wrapDidDocument(\n    did: string,\n    address: string,\n    controllerKey: string | undefined,\n    history: ERC1056Event[],\n    chainId: number,\n    blockHeight: string | number,\n    now: BigNumber\n  ): { didDocument: DIDDocument; deactivated: boolean; versionId: number; nextVersionId: number } {\n    const baseDIDDocument: DIDDocument = {\n      '@context': [\n        'https://www.w3.org/ns/did/v1',\n        'https://identity.foundation/EcdsaSecp256k1RecoverySignature2020/lds-ecdsa-secp256k1-recovery2020-0.0.jsonld',\n      ],\n      id: did,\n      verificationMethod: [],\n      authentication: [],\n      assertionMethod: [],\n    }\n\n    let controller = address\n\n    const authentication = [`${did}#controller`]\n\n    let versionId = 0\n    let nextVersionId = Number.POSITIVE_INFINITY\n    let deactivated = false\n    let delegateCount = 0\n    let serviceCount = 0\n    const auth: Record<string, string> = {}\n    const pks: Record<string, VerificationMethod> = {}\n    const services: Record<string, ServiceEndpoint> = {}\n    for (const event of history) {\n      if (blockHeight !== -1 && event.blockNumber > blockHeight) {\n        if (nextVersionId > event.blockNumber) {\n          nextVersionId = event.blockNumber\n        }\n        continue\n      } else {\n        if (versionId < event.blockNumber) {\n          versionId = event.blockNumber\n        }\n      }\n      const validTo = event.validTo || BigNumber.from(0)\n      const eventIndex = `${event._eventName}-${\n        (<DIDDelegateChanged>event).delegateType || (<DIDAttributeChanged>event).name\n      }-${(<DIDDelegateChanged>event).delegate || (<DIDAttributeChanged>event).value}`\n      if (validTo && validTo.gte(now)) {\n        if (event._eventName === eventNames.DIDDelegateChanged) {\n          const currentEvent = <DIDDelegateChanged>event\n          delegateCount++\n          const delegateType = currentEvent.delegateType //conversion from bytes32 is done in logParser\n          switch (delegateType) {\n            case 'sigAuth':\n              auth[eventIndex] = `${did}#delegate-${delegateCount}`\n            // eslint-disable-line no-fallthrough\n            case 'veriKey':\n              pks[eventIndex] = {\n                id: `${did}#delegate-${delegateCount}`,\n                type: verificationMethodTypes.EcdsaSecp256k1RecoveryMethod2020,\n                controller: did,\n                blockchainAccountId: `${currentEvent.delegate}@eip155:${chainId}`,\n              }\n              break\n          }\n        } else if (event._eventName === eventNames.DIDAttributeChanged) {\n          const currentEvent = <DIDAttributeChanged>event\n          const name = currentEvent.name //conversion from bytes32 is done in logParser\n          const match = name.match(/^did\\/(pub|svc)\\/(\\w+)(\\/(\\w+))?(\\/(\\w+))?$/)\n          if (match) {\n            const section = match[1]\n            const algorithm = match[2]\n            const type = legacyAttrTypes[match[4]] || match[4]\n            const encoding = match[6]\n            switch (section) {\n              case 'pub': {\n                delegateCount++\n                const pk: LegacyVerificationMethod = {\n                  id: `${did}#delegate-${delegateCount}`,\n                  type: `${algorithm}${type}`,\n                  controller: did,\n                }\n                pk.type = legacyAlgoMap[pk.type] || algorithm\n                switch (encoding) {\n                  case null:\n                  case undefined:\n                  case 'hex':\n                    pk.publicKeyHex = currentEvent.value.slice(2)\n                    break\n                  case 'base64':\n                    pk.publicKeyBase64 = Buffer.from(currentEvent.value.slice(2), 'hex').toString('base64')\n                    break\n                  case 'base58':\n                    pk.publicKeyBase58 = Base58.encode(Buffer.from(currentEvent.value.slice(2), 'hex'))\n                    break\n                  case 'pem':\n                    pk.publicKeyPem = Buffer.from(currentEvent.value.slice(2), 'hex').toString()\n                    break\n                  default:\n                    pk.value = currentEvent.value\n                }\n                pks[eventIndex] = pk\n                if (match[4] === 'sigAuth') {\n                  auth[eventIndex] = pk.id\n                }\n                break\n              }\n              case 'svc':\n                serviceCount++\n                services[eventIndex] = {\n                  id: `${did}#service-${serviceCount}`,\n                  type: algorithm,\n                  serviceEndpoint: Buffer.from(currentEvent.value.slice(2), 'hex').toString(),\n                }\n                break\n            }\n          }\n        }\n      } else if (event._eventName === eventNames.DIDOwnerChanged) {\n        const currentEvent = <DIDOwnerChanged>event\n        controller = currentEvent.owner\n        if (currentEvent.owner === nullAddress) {\n          deactivated = true\n          break\n        }\n      } else {\n        if (\n          event._eventName === eventNames.DIDDelegateChanged ||\n          (event._eventName === eventNames.DIDAttributeChanged &&\n            (<DIDAttributeChanged>event).name.match(/^did\\/pub\\//))\n        ) {\n          delegateCount++\n        } else if (\n          event._eventName === eventNames.DIDAttributeChanged &&\n          (<DIDAttributeChanged>event).name.match(/^did\\/svc\\//)\n        ) {\n          serviceCount++\n        }\n        delete auth[eventIndex]\n        delete pks[eventIndex]\n        delete services[eventIndex]\n      }\n    }\n\n    const publicKeys: VerificationMethod[] = [\n      {\n        id: `${did}#controller`,\n        type: verificationMethodTypes.EcdsaSecp256k1RecoveryMethod2020,\n        controller: did,\n        blockchainAccountId: `${controller}@eip155:${chainId}`,\n      },\n    ]\n\n    if (controllerKey && controller == address) {\n      publicKeys.push({\n        id: `${did}#controllerKey`,\n        type: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n        controller: did,\n        publicKeyHex: controllerKey,\n      })\n      authentication.push(`${did}#controllerKey`)\n    }\n\n    const didDocument: DIDDocument = {\n      ...baseDIDDocument,\n      verificationMethod: publicKeys.concat(Object.values(pks)),\n      authentication: authentication.concat(Object.values(auth)),\n    }\n    if (Object.values(services).length > 0) {\n      didDocument.service = Object.values(services)\n    }\n    didDocument.assertionMethod = [...(didDocument.verificationMethod?.map((pk) => pk.id) || [])]\n\n    return deactivated\n      ? {\n          didDocument: { ...baseDIDDocument, '@context': 'https://www.w3.org/ns/did/v1' },\n          deactivated,\n          versionId,\n          nextVersionId,\n        }\n      : { didDocument, deactivated, versionId, nextVersionId }\n  }\n\n  async resolve(\n    did: string,\n    parsed: ParsedDID,\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    _unused: Resolvable,\n    options: DIDResolutionOptions\n  ): Promise<DIDResolutionResult> {\n    const fullId = parsed.id.match(identifierMatcher)\n    if (!fullId) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.invalidDid,\n          message: `Not a valid did:ethr: ${parsed.id}`,\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n    const id = fullId[2]\n    const networkId = !fullId[1] ? 'mainnet' : fullId[1].slice(0, -1)\n    let blockTag: string | number = options.blockTag || 'latest'\n    if (typeof parsed.query === 'string') {\n      const qParams = qs.decode(parsed.query)\n      blockTag = typeof qParams['versionId'] === 'string' ? qParams['versionId'] : blockTag\n      try {\n        blockTag = Number.parseInt(<string>blockTag)\n      } catch (e) {\n        blockTag = 'latest'\n        // invalid versionId parameters are ignored\n      }\n    }\n\n    if (!this.contracts[networkId]) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.unknownNetwork,\n          message: `The DID resolver does not have a configuration for network: ${networkId}`,\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n\n    let now = BigNumber.from(Math.floor(new Date().getTime() / 1000))\n\n    if (typeof blockTag === 'number') {\n      const block = await this.getBlockMetadata(blockTag, networkId)\n      now = BigNumber.from(Date.parse(block.isoDate) / 1000)\n    } else {\n      // 'latest'\n    }\n\n    const { address, history, controllerKey, chainId } = await this.changeLog(id, networkId, 'latest')\n    try {\n      const { didDocument, deactivated, versionId, nextVersionId } = this.wrapDidDocument(\n        did,\n        address,\n        controllerKey,\n        history,\n        chainId,\n        blockTag,\n        now\n      )\n      const status = deactivated ? { deactivated: true } : {}\n      let versionMeta = {}\n      let versionMetaNext = {}\n      if (versionId !== 0) {\n        const block = await this.getBlockMetadata(versionId, networkId)\n        versionMeta = {\n          versionId: block.height,\n          updated: block.isoDate,\n        }\n      }\n      if (nextVersionId !== Number.POSITIVE_INFINITY) {\n        const block = await this.getBlockMetadata(nextVersionId, networkId)\n        versionMetaNext = {\n          nextVersionId: block.height,\n          nextUpdate: block.isoDate,\n        }\n      }\n      return {\n        didDocumentMetadata: { ...status, ...versionMeta, ...versionMetaNext },\n        didResolutionMetadata: { contentType: 'application/did+ld+json' },\n        didDocument,\n      }\n    } catch (e) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.notFound,\n          message: e.toString(), // This is not in spec, nut may be helpful\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n  }\n\n  build(): Record<string, DIDResolver> {\n    return { ethr: this.resolve.bind(this) }\n  }\n}\n"],"names":["identifierMatcher","nullAddress","DEFAULT_REGISTRY_ADDRESS","verificationMethodTypes","eventNames","legacyAttrTypes","sigAuth","veriKey","enc","legacyAlgoMap","Secp256k1VerificationKey2018","EcdsaSecp256k1VerificationKey2019","Ed25519SignatureAuthentication2018","Ed25519VerificationKey2018","Secp256k1SignatureAuthentication2018","RSAVerificationKey2018","X25519KeyAgreementKey2019","bytes32toString","input","buff","Buffer","from","slice","toString","replace","stringToBytes32","str","buffStr","repeat","length","interpretIdentifier","identifier","id","network","undefined","startsWith","split","components","splice","join","address","computeAddress","publicKey","getAddress","knownInfuraNetworks","mainnet","ropsten","rinkeby","goerli","kovan","knownNetworks","rsk","artis_t1","artis_s1","matic","maticmum","Errors","configureNetworksWithInfura","projectId","networks","name","chainId","provider","InfuraProvider","configureNetworks","getContractForNetwork","conf","web3","currentProvider","rpcUrl","chainIdRaw","BigNumber","toNumber","networkName","JsonRpcProvider","Error","contract","ContractFactory","fromSolidity","DidRegistryContract","attach","registry","connect","configureNetwork","net","reduce","configureResolverWithNetworks","infuraProjectId","Object","keys","EthrDidController","constructor","signer","chainNameOrId","did","prov","networkString","getOwner","blockTag","functions","identityOwner","result","attachContract","controller","currentOwner","getSigner","changeOwner","newOwner","options","overrides","gasLimit","gasPrice","ownerChange","wait","addDelegate","delegateType","delegateAddress","exp","delegateTypeBytes","addDelegateTx","revokeDelegate","setAttribute","attrName","attrValue","setAttrTx","revokeAttribute","revokeAttributeTX","populateEventMetaClass","logResult","blockNumber","eventFragment","inputs","args","TypeError","forEach","index","val","type","_eventName","logDecoder","logs","results","map","log","res","interface","parseLog","event","state","prototype","s","e","o","_this","thenable","test","updateValue","pact","stage","then","_resumeAfterBody","getResolver","EthrDidResolver","build","contracts","networkId","previousChange","changed","getBlockMetadata","blockHeight","getBlock","block","height","number","isoDate","Date","timestamp","toISOString","changeLog","identity","hexChainId","history","controllerKey","getLogs","topics","fromBlock","toHexString","toBlock","events","reverse","unshift","lt","getNetwork","wrapDidDocument","now","baseDIDDocument","verificationMethod","authentication","assertionMethod","versionId","nextVersionId","Number","POSITIVE_INFINITY","deactivated","delegateCount","serviceCount","auth","pks","services","validTo","eventIndex","delegate","value","gte","DIDDelegateChanged","currentEvent","EcdsaSecp256k1RecoveryMethod2020","blockchainAccountId","DIDAttributeChanged","match","section","algorithm","encoding","pk","publicKeyHex","publicKeyBase64","publicKeyBase58","Base58","encode","publicKeyPem","serviceEndpoint","DIDOwnerChanged","owner","publicKeys","push","didDocument","concat","values","service","resolve","parsed","_unused","didDocumentMetadata","status","versionMeta","versionMetaNext","didResolutionMetadata","contentType","nextUpdate","updated","error","notFound","message","fullId","invalidDid","query","qParams","qs","decode","parseInt","unknownNetwork","Math","floor","getTime","parse","ethr","bind"],"mappings":"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"}